# Https 특강

## 소개

- 남수진(DONALD)
- 카카오 엔터프라이즈 근무
  - B2B, 기업 관공서 대상 서비스



[이미지 소스](https://www.cloudflare.com/learning/ssl/what-is-ssl/)





## Https

- **Http의 암호화 버전**

- Http: 텍스트 프로토콜
  - GET, header 등 텍스트 기반 프로토콜임
  - 그래서 패킷을 캡쳐해보면 안의 내용이 그대로 공개된다.

- Http vs Https

  - Http: Insecure Connection

  - Https: Encrypted Connection
    - SSL Certificate
    - 암호화된 채널: 암호화해서 보내고, 복호화해서 보고



## 암호화 알고리즘

### 메시지 다이제스트(Message Digest)

- 일방향 함수

- 해시키 라고도 함
- 메시지 무결성(Integrity) 검사를 위하여 암호 해시 함수를 이용하여 생성하는 크기가 고정된 값
- 특성
  - **비예측성(Unpredictability)**
    - 원본이 조금만 바뀌어도 완전히 다른 값을 가져와야 함
  - **역상 저항성(Preimage Resistance)**
    - 해시값에서 preimage(원본)를 읽어낼 수 없어야 한다.
  - **충돌 저항성(Collision Resistance)**
    - 겹치는 해시값이 존재(충돌)하게끔 해시값을 만들면 안 된다.
- MD5(16byte), SHA-256, KECCAK-256
- 용례: 비밀번호



### 대칭 키 암호화(Symmetric-Key Algorithm)

- 암호화할 때와 복호화 할 때에 같은 키를 사용하는 암호
- 대칭 키를 비밀 키라고도 한다.
- 대개 안전하며 암복호 속도가 매우 빠름
- 대칭 키를 공유해야 하는 문제가 있다.
- AES128-CBC, AES256-GCM, ...
  - CBC, GCM 블록 운영 모드
  - 알고리즘(AES)|블록사이즈(128)_블록모드(CBC)



### 공개 키 암호화, Public-Key(Asymmetric-Key Algorithm) 

- 암호화 역사를 뒤집은 사건

- 비대칭 키를 사용함
- 개인키와 공개 키
  - 공개 키는 개인 키로 유도하여 만든다.
  - 공개 키로 암호화 하고, 개인 키로 복호화한다.
  - 개인 키의 보관이 중요
- 암복호의 비용이 대칭 키 암호화에 비하여 매우 크다.
- Diffie-Hellman, RSA, ECC, ...
  - ECC는 블록체인, 암호화폐에서 종종 사용
- 키 공유를 할 필요가 없다는 장점
  - **Https의 핵심**



### 전자 서명(DSA; Digital Signature Algorithm)

- 개인 키로 서명하고, 공개 키로 검증한다.

- A는 원본 파일의 메시지 다이제스트(MD)를 구하고, 그 MD값을 A의 개인 키로 서명하여 B에게 원본 파일과 서명을 보낸다.

- B는 이미 가지고 있는 A의 공개 키를 사용하여 A가 보내 온 원본 파일과 서명을 검증한다.

  - 원본성 확인이 가능

- RSA, ECDSA, ...

- 공인인증서

- PKI 공개키 기반 구조

- Https는 다음을 사용

  - DSA
  - 공개키 알고리즘

  

## SSL 인증서

- Http vs Https

  - Http: Insecure Connection

  - Https: Encrypted Connection
    - SSL Certificate
    - 암호화된 채널: 암호화해서 보내고, 복호화해서 보고

- 위의 방식은 Https의 **대칭 키** 암호화이다.
- **대칭키를 어떻게 공유할 것이냐**가 핵심
- Https 는 대칭 키 암호화 채널을 생성
- **암호화되지 않은 통신망에서 대칭 키를 어떻게 공유?**
  - **공개 키 암호화방식으로 대칭 키를 공유한다!**



### 키 교환 과정(Key Exchange)

- 암호화되지 않은 통신망에
  - CLI -> SRV 공개 키 요청, 받음
  - CLI는 대칭 키 생성, 공개 키로 암호화 한 후 --> SRV
  - SRV는 암호화된 대칭키를 자신의 개인 키로 복호화하여 대칭 키를 얻음
- 이 공유된 대칭 키를 **세션 키**라고 한다.
  - 어차피 공개 키로 암호화한 것은 서버만 볼 수 있으니까 보안성
  - 간단한 내용이라 암호화한 것이지
    이렇게 다시 암호화하는 것은 비용(연산)이 너무 많이 든다.

- **그런데 서버가 보낸 공개 키가 진본임을 어떻게 믿을 수 있는가?**
  - 수 많은 라우터 등을 거쳐서 가는데, 그 사이에 탈취되지 않았을거란 보장은?
    -> 중간자 공격



#### 중간자 공격(MITM; Man In The Middle attack)

- 공격자가 통신 객체가 전송하는 공개 키를 자신의 공개 키로 바꾸는 것
- 따라서 증명을 위한 일종의 장치가 필요하다!
  -> (SSL) 인증서



### 인증서와 인증 기관

- 인증서는 서버의 공개 키를 권위 있는 인증기관이 서명한 증서이다.
- **인증서(Certificates)**는 다음 정보들의 조합이다.
  - **서버의 공개 키**
  - 도메인 이름을 비롯한 서버의 여러 정보들
  - 둘을 합한 것을 **인증 기관이 자신의 개인 키**로 서명한 값
- **인증 기관(CA; Certificate Authorities)**
  - 인증서를 발행하는 신뢰할 수 있는 기관, 놀랍게도 상업기관
  - CA는 서버가 제출한 서류(CSR)를 심사하여,
    자신의 개인 키로 서명한 값을 추가한 인증서를 생성하여 서버에게 돈을 받고 준다. (매년/격년)
  - 각 운영체제와 웹 브라우저는 유명한 CA의 인증서(공개 키)를 미리 가지고 있다.
    - `user/local/share/ca-certificates`
  - [예시](https://www.kicassl.com/sslcert/sslprodguid/formSslProdGuid.sg)

- 루트 인증서와 인증기관
- 2020년 8월 24일 현재 52개 조직을 대표하는 147개의 루트 인증서가 [Mozilla Firefox](https://en.wikipedia.org/wiki/Mozilla_Firefox) 웹 브라우저 에서 신뢰되고 [[9\]](https://en.wikipedia.org/wiki/Certificate_authority#cite_note-9) 60개 조직을 대표하는 168개의 루트 인증서가 [macOS](https://en.wikipedia.org/wiki/MacOS) 에서 신뢰되고 [[10\]](https://en.wikipedia.org/wiki/Certificate_authority#cite_note-10) 101개 조직을 대표하는 255개의 루트 인증서 , [Microsoft Windows](https://en.wikipedia.org/wiki/Microsoft_Windows) 에서 신뢰합니다 . [[11\]](https://en.wikipedia.org/wiki/Certificate_authority#cite_note-11) Android 4.2(Jelly Bean) 현재 Android에는 각 릴리스와 함께 업데이트되는 100개 이상의 CA가 포함되어 있습니다. [[12\]](https://en.wikipedia.org/wiki/Certificate_authority#cite_note-12)
  (위키백과 참고)





### 키 교환 과정(추가)

- 공개키 암호화 방식을 이용하여 암호화 되지 않은 통신망을 통해 대칭키를 공유할 수 있도록 한다.
- A는 B에게 공개 키(인증서)를 달라고 한다.  B는 자신의 공개 키가 들어있는 권위 있는 인증기관이 인증한 인증서를 보낸다．
- A는 자신이 이미 가지고 있는 인증기관의 인증서(공개키)로 B가보내온 인증서의 서명값을 검증한다. 
  맞으면, 대칭키를 생성하여 인증서에 포함된 B의 공개키로 암호화해서 B에게보낸다.
- B는 A가 보내온 암호화된 대칭키를 자신의 비밀키로 복호화하여 대칭키를 얻는다.
- 따라서 암호화된 채널을 만들기 위해서는 클라이언트와 서버간에 키교환, 전자서명,  암호해시,  대칭키 암호화 알고리즘이 서로 약속 되어야한다. 이것을 암호
  모음(Cipher Suite)이라고 한다．

- 정리

  - 1차 때만 공개키

    - 대칭키를 공유하기 위함
    - 세션키
      - 세션 키는 그 세션에만 적용된다.

  - 1차 때를 통해 얻은 대칭키를 사용하여 보안 갖춤

    



#### 암호 모음 형식 Kx-Au-Enc-Mac

- 키교환(Kx) 
- 서명인증(Au)
- 대칭키 암호화(Enc) 
- 메시지 다이제스트(Mac) 



##### 예제

server {

...

}의 내용 설명

- ssl은 433 포트

- ssl-ciphers: 서버가 제공하는 암호화 목록임
  - 로케일처럼 서버의 선호 순으로 보내준다.



## 전송계층 보안

- **TLS; Tanspost Layer Security**
  - 과거에는 SSL(Secure Sockets Layer)이라고 불림. 이제는 관습화하여 SSL이라고 계속해서 잘못 부름
  - Https의 s를 담당하는중

- 전송 계층 보안, 전송 데이터 암호화
- **단어와 달리 물리적 계층이 당연히 아니다!**

- 개인 프로토콜을 사용하려고 할 경우 오픈 SSL을 이용해서 개발하면 된다.
- 역사
  - 1995: 넷스케이프에서 SSL 개발.
    - SSL 1.0, SSL 2.0, SSL 3.0
  - 1999: SSL 3.0을 보완하여 TLS 1.0 탄생.
    - 과거의 잘못된 알고리즘 많이 남아있고, 지나치게 무거운 상태인 등 아예 새로 만들 이유가 많았음.
    - 현재 버전은 TLS 1.3(2018)
    - 아직도 1.3을 지원하지 않는 브라우저들이 있음.
- 두 개의 주요 프로토콜로 구성
  - **레코드 프로토콜**
    - 전송할 자료의 형식을 결정
    - 암호화가 이루어진다.
    - 자료는 TLS 레코드 형태로 전송, 레코드는 패킷의 이름이다.
  - 핸드셰이크 프로토콜
    - 자료를 전송하는 방법
    - 이 방법이 바로 키 교환/합의 프로토콜이다.

- TLS는 자신이 전송하는 자료의 의미는 신경쓰지 않는다.
- **통신 프로토콜/응용 프로그램과는 독립적이다.**



### 핸드셰이크 프로토콜

- 클라이언트의 Chipher suites, 세션 id, ssl 버전 등을 포함한 패킷을 서버로 전송
- 서버 측에서 생성한 랜덤 데이터 선택한 암호화 방식등 패킷을 클라이언트 전송
  - SSL 인증서 CLI 전송
  - 서버가 행동 마쳤음을 전달
- 클라이언트가 대칭 키를 생성하여 서버의 공개키로 암호화하여 전달한다.
- 클라이언트와 서버가 서로에게 통신할 준비가 되었음을 알린다.



## 웹서버(nginx) ssl 설정 방법

- **openssl 명령어 익혀두면 좋다!!!**



[상당히 도움이 되는 글](https://engineering.linecorp.com/ko/blog/best-practices-to-secure-your-ssl-tls/)



## 추가 참고자료

암호화 알고리즘 처음 듣는 친구들을 위한 핵심 키워드 볼드로 요약1 - [참고 벨로그](https://velog.io/@inyong_pang/Programming-암호화-알고리즘-종류와-분류)

- 평문(Plaintext) : 해독 가능한 형태의 메시지(암호화전 메시지)

- 암호문(Cipertext) : 해독 불가능한 형태의 메시지(암호화된 메시지

- **암호화(Encryption) : 평문을 암호문으로 변환하는 과정**

- **복호화(Decryption) : 암호문을 평문으로 변환하는 과정**

- 전자서명

- 양방향 암호화(대칭/비대칭 키)

  - **대칭키 : 같은 키를 이용하여 메시지를 암.복호화 하는 것**
  - **비대칭키(=공개키)** : 메시지를 암호화 하는 키와 복호화 하는 키가 다름

  - 암호화 알고리즘에 따라 사용방식이 다를수도 있다

  - 전자서명을 위한 알고리즘에서는 **Private Key로 메시지를 서명하고, Public Key로 검증**

  - 메시지 교환에서는 **Public Key로 메시지를 암호화**하고 **Private Key로 복호화**한다.

  - **대표 암호 알고리즘 RSA**

  - 암호화 알고리즘 처음 듣는 친구들을 위한 핵심 키워드 볼드로 요약3**대칭키** 암호화

    - 종류 : AES128, AES256, SEED(국내표준)
    - **암.복호화 키가 같음**

    **비대칭키** 암호화

    - 종류 : DSA(전자서명), **RSA(메시지 암.복호화)**
    - 대칭키에 비해서는 느리다는 단점이 있음
    - **키생성시 Private Key와 Public Key 2개의 키**가 도출되며, **Public Key는 공개해도 문제가 되지 않는다.**
    - **인수분해**, 이산대수, 타원곡선 암호화로 나뉨

- 송신자의 Private Key로 메시지를 서명하여 전달
- 수신자측에서는 송신자의 Public Key를 이용하여 서명값을 검증

- 양방향암호화 : 암호화와 복호화과정을 통해 송.수신간 주고받는 메시지를 안전하게 암.복호화하는 과정
- **단방향암호화 : 해싱(Hashing)을 이용한 암호화 방식으로 양방향과는 다른 개념으로, 평문을 암호문으로 암호화는 가능하지만 암호문을 평문으로 복호화 하는 것은 불가능.**